<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>SSC Mock Exam — Full Interface + Summary</title>

<!-- MathJax -->
<script>
window.MathJax = {
  tex: { inlineMath: [["\\(","\\)"]], displayMath: [["\\[","\\]"]] },
  svg: { fontCache: "global" }
};
</script>
<script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js"></script>

<style>
:root{
  --primary:#0b57a4;
  --accent:#ffb000;
  --bg:#f5f7fb;
  --card:#ffffff;
  --muted:#666;
  --green:#d4edda;
  --red:#f8d7da;
}
*{box-sizing:border-box}
body{ margin:0; font-family:Inter,Segoe UI,Arial; background:var(--bg); color:#111; -webkit-user-select:none; user-select:none; }

/* Topbar */
.topbar{ height:60px; background:linear-gradient(90deg,var(--primary),#083f7a); color:#fff; display:flex; align-items:center; justify-content:space-between; padding:0 14px; gap:12px; position:sticky; top:0; z-index:50; }
.brand{display:flex; align-items:center; gap:12px; font-weight:700}
.brand .logo{ width:42px; height:42px; border-radius:6px; background:#fff3; display:flex; align-items:center; justify-content:center; font-weight:800; color:#fff; }
.topbar .controls{display:flex; align-items:center; gap:8px}
.topbtn{ background:rgba(255,255,255,0.12); border:1px solid rgba(255,255,255,0.12); color:#fff; padding:8px 10px; border-radius:6px; cursor:pointer; font-weight:700; }

/* three-box palette icon */
.icon-boxes{ width:28px; height:20px; display:inline-grid; grid-template-columns:repeat(3,1fr); gap:4px; }
.icon-boxes span{ display:block; width:8px; height:8px; background:rgba(255,255,255,0.95); border-radius:2px; }

/* layout */
.app{ display:grid; grid-template-columns: 1fr 260px; gap:18px; padding:18px; max-width:1200px; margin:18px auto; }
@media(max-width:950px){ .app{ grid-template-columns:1fr; padding:12px } }

/* left column: main */
.main{ display:flex; flex-direction:column; gap:12px; }

/* sections row */
.sections{ display:flex; gap:8px; flex-wrap:wrap; }
.sectionBtn{ padding:10px 14px; background:var(--card); border-radius:8px; cursor:pointer; border:1px solid #e3e7ee; font-weight:700; color:var(--muted); }
.sectionBtn.active{ background:var(--primary); color:#fff; border-color:var(--primary)}

/* question card */
.card{ background:var(--card); border-radius:12px; padding:16px; box-shadow:0 6px 18px rgba(12,36,80,0.06); }
.qmeta{ display:flex; justify-content:space-between; align-items:center; gap:12px; margin-bottom:8px}
.qtext{ font-size:18px; line-height:1.4; margin-bottom:10px}
.options{ display:flex; flex-direction:column; gap:10px}
.opt{ padding:12px; border-radius:8px; border:1px solid #e6e9f0; background:#fbfdff; cursor:pointer; user-select:none; }
.opt.selected{ border-color:var(--primary); background:#eaf3ff; box-shadow:0 1px 0 rgba(11,87,164,0.05)}
.opt.correct{ background:var(--green); border-color:#28a745; }
.opt.wrong-selected{ background:var(--red); border-color:#dc3545; color:#721c24; }

/* meta */
.metaRow{ display:flex; gap:8px; align-items:center; margin-top:10px}
.small{ font-size:13px; color:var(--muted)}

/* footer nav */
.footerNav{ display:flex; gap:10px; justify-content:space-between; align-items:center; margin-top:12px; }
.btn{ padding:12px 14px; border-radius:8px; border:none; cursor:pointer; font-weight:800; background:var(--primary); color:#fff; }
.btn.secondary{ background:#fff; color:var(--primary); border:1px solid var(--primary) }
.btn.warn{ background:var(--accent); color:#111 }

/* right palette */
.palette{ width:260px; position:sticky; top:76px; align-self:start; height:calc(100vh - 110px); }
@media(max-width:950px){ .palette{ display:none }}

/* palette UI */
.palette .card{ height:100%; padding:12px; display:flex; flex-direction:column }
.palette .palHeader{ display:flex; justify-content:space-between; align-items:center; margin-bottom:8px}
.qgrid{ display:flex; flex-wrap:wrap; gap:8px; }
.pBtn{ width:44px; height:44px; display:inline-flex; align-items:center; justify-content:center; background:#eee; border-radius:50%; font-weight:700; cursor:pointer; border:1px solid #ddd; }
.pBtn.notVisited{ background:#ffdbe6 } /* pink */
.pBtn.visited{ background:#c7f0c6 } /* green */
.pBtn.marked{ background:#ffe1b3 } /* yellow */
.pBtn.current{ outline:3px solid rgba(11,87,164,0.12) }

/* mobile sliding palette */
.mobilePalette{ position:fixed; right:-320px; top:60px; width:300px; height:calc(100% - 60px); background:var(--card); box-shadow:-8px 0 30px rgba(0,0,0,0.15); transition:0.28s; z-index:90; padding:12px; }
.mobilePalette.open{ right:0 }
.overlay{ display:none; position:fixed; inset:0; background:rgba(0,0,0,0.45); z-index:85; }
.overlay.show{ display:block }

/* login modal */
#loginModal{ position:fixed; inset:0; display:flex; justify-content:center; align-items:center; z-index:120; background:linear-gradient(180deg, rgba(2,6,23,0.45), rgba(2,6,23,0.35)); }
.loginCard{ width:420px; max-width:95%; background:var(--card); border-radius:12px; padding:20px; box-shadow:0 12px 30px rgba(2,6,23,0.15) }
.input{ width:100%; padding:12px; border-radius:8px; border:1px solid #e3e7ee; margin:8px 0; font-size:16px}
.smallNote{ font-size:13px; color:var(--muted)}

/* SUMMARY PAGE (Style A: SSC official) */
#summaryPage{ display:none; padding:40px; }
.summaryBox{
  width:720px; max-width:95%; margin:28px auto; background:#fff; border:1px solid #e6e6e6; padding:18px; border-radius:6px;
}
.summaryHeader{ background:#4b2d73; color:#fff; padding:12px; border-radius:4px; font-weight:800; }
.summaryTable{ width:100%; border-collapse:collapse; margin-top:12px; }
.summaryTable td{ padding:10px; border-bottom:1px solid #eee; }
.summaryBtns{ display:flex; gap:8px; justify-content:flex-end; margin-top:12px; }

/* review header */
.reviewHeader{ display:flex; gap:12px; align-items:center; margin-bottom:12px; }

/* responsive tweaks */
@media(max-width:640px){ .qtext{ font-size:16px } .btn{ padding:10px; font-size:14px } .topbar{ padding:0 8px } .summaryBox{ width:95% } }
</style>
</head>
<body>

<!-- TOPBAR -->
<div class="topbar">
  <div class="brand">
    <div class="logo">SSC</div>
    <div>
      <div style="font-size:15px">SSC Mock Exam</div>
      <div style="font-size:12px;opacity:0.9">Full Test Interface</div>
    </div>
  </div>

  <div class="controls">
    <div id="timerDisplay" class="topbtn">00:00</div>
    <button class="topbtn" id="fullscreenBtn" title="Enter fullscreen">⤢ Fullscreen</button>
    <button class="topbtn" id="togglePaletteTop" title="Toggle Question Palette">
      <span class="icon-boxes" aria-hidden="true"><span></span><span></span><span></span></span>
    </button>
    <div id="userMobileDisplay" class="topbtn" style="background:transparent;border:1px solid rgba(255,255,255,0.15)"></div>
  </div>
</div>

<!-- APP LAYOUT -->
<div id="mainApp" class="app" style="display:none">
  <div class="main">
    <div class="sections card" id="sectionsRow"></div>

    <div class="card" id="questionArea">
      <div class="qmeta">
        <div><span id="qIndexText">Q1</span> <span class="small">| Section: <b id="qSectionText"></b></span></div>
        <div class="small">Time per test: <b id="timePerTestText"></b></div>
      </div>

      <div id="reviewBanner" style="display:none" class="reviewHeader card">
        <div style="font-weight:800; color:var(--primary)">REVIEW MODE</div>
        <div class="small">Answers are disabled. Correct answers highlighted green. Wrong selections in red.</div>
      </div>

      <div class="qtext" id="qText">Loading question...</div>

      <div class="options" id="optionsBox"></div>

      <div class="metaRow">
        <div class="small"><b>Marked:</b> <span id="markedStatus">No</span></div>
        <div class="small"><b>Saved:</b> <span id="savedStatus">Yes</span></div>
      </div>

      <div class="footerNav">
        <div style="display:flex;gap:10px;">
          <button class="btn secondary" id="prevBtn">Previous</button>
          <button class="btn secondary" id="saveBtn">Save</button>
          <button class="btn secondary" id="markBtn">Mark for Review</button>
        </div>
        <div style="display:flex;gap:8px;">
          <button class="btn" id="nextBtn">Next</button>
          <button class="btn warn" id="submitBtn">Submit Test</button>
        </div>
      </div>
    </div>

    <div class="card smallNote">
      <b>Note:</b> Copy/paste, right-click and common devtools shortcuts are disabled (best-effort). Fullscreen is available.
    </div>
  </div>

  <div class="palette">
    <div class="card">
      <div class="palHeader">
        <div><b>Question Palette</b></div>
        <div><button class="btn secondary" id="paletteToggle">Toggle</button></div>
      </div>
      <div style="margin-bottom:8px" class="small">Tap a number to jump. Colors — Pink:not visited, Green:visited, Yellow:marked</div>
      <div class="qgrid" id="paletteGrid"></div>

      <div style="margin-top:auto; display:flex; gap:8px; align-items:center;">
        <button class="btn secondary" id="showSummaryBtn">Show Summary</button>
        <div class="small" style="margin-left:auto">Saved to browser</div>
      </div>
    </div>
  </div>
</div>

<!-- MOBILE SLIDING PALETTE -->
<div class="mobilePalette" id="mobilePalette">
  <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px">
    <div><b>Questions</b></div>
    <div><button class="btn secondary" id="mobileClosePal">Close</button></div>
  </div>
  <div class="qgrid" id="mobilePaletteGrid"></div>
</div>
<div class="overlay" id="overlay"></div>

<!-- LOGIN MODAL -->
<div id="loginModal">
  <div class="loginCard card">
    <h2>Login — Enter Mobile Number</h2>
    <input id="mobileInput" class="input" type="tel" placeholder="Enter mobile number (10 digits)" />
    <div style="display:flex; gap:8px; margin-top:6px">
      <button class="btn" id="loginBtn">Start Test</button>
      <button class="btn secondary" id="resumeBtn">Resume Previous</button>
    </div>
    <div style="margin-top:10px" class="smallNote">
      Allowed mobile numbers are controlled in the script. This demo saves progress locally in your browser.
    </div>
    <div id="loginError" style="color:#b00020; margin-top:8px; font-weight:700"></div>
  </div>
</div>

<!-- SUMMARY PAGE (Style A SSC Official) -->
<div id="summaryPage">
  <div class="summaryBox">
    <div class="summaryHeader">Test Summary</div>
    <table class="summaryTable">
      <tr><td>Total Questions</td><td id="sum_total">0</td></tr>
      <tr><td>Attempted</td><td id="sum_attempted">0</td></tr>
      <tr><td>Not Attempted</td><td id="sum_notattempted">0</td></tr>
      <tr><td>Marked for Review</td><td id="sum_marked">0</td></tr>
      <tr><td>Attempted & Marked</td><td id="sum_attempted_marked">0</td></tr>
      <tr><td>Time Taken</td><td id="sum_time">0</td></tr>
      <tr><td>Score (auto)</td><td id="sum_score">0</td></tr>
    </table>

    <div class="summaryBtns">
      <button class="btn secondary" id="returnTestBtn">Return to Test</button>
      <button class="btn" id="confirmSubmitBtn">Confirm Submit</button>
    </div>
  </div>
</div>

<!-- SUBMIT CONFIRM / FINAL PAGE (simple) -->
<div id="finalPage" style="display:none; padding:40px; text-align:center;">
  <h2>Test Submitted</h2>
  <p>Your responses were sent to Google Sheets (if form configured).</p>
  <button class="btn" onclick="location.reload()">OK</button>
</div>

<script>
/* ======================== CONFIG ========================= */
// Allowed numbers
const VALID_MOBILE_NUMBERS = ["6301186741","9999999999","8888888888"];

// Google Form placeholders (replace with your values)
const GOOGLE_FORM_ACTION = "https://docs.google.com/forms/d/e/YOUR-GOOGLE-FORM-ID/formResponse";
const ENTRY_MOBILE = "entry.111111111";   // mobile field name
const ENTRY_ANSWERS = "entry.222222222"; // answers JSON field name

/* ========================= QUESTIONS (example) ======================== */
/* Each question: { id, section, q, opts:[], key } */
const QUESTIONS = [
  { id:1, section:"Quant", q:"Solve: \\(12x+6=30\\). Find \\(x\\).", opts:["1","2","3","4"], key:"2" },
  { id:2, section:"Quant", q:"Value of \\(\\frac{(a+b)^2-(a-b)^2}{4ab}\\) ?", opts:["1","2","a","b"], key:"1" },
  { id:3, section:"Reasoning", q:"Series: 2,4,8,16, ? (choose)", opts:["24","32","64","48"], key:"32" },
  { id:4, section:"English", q:"Antonym of 'Brave'", opts:["Cowardly","Bold","Strong","Happy"], key:"Cowardly" },
  { id:5, section:"GK", q:"Capital of India?", opts:["Mumbai","New Delhi","Kolkata","Chennai"], key:"New Delhi" }
];

/* ========================= STATE ============================ */
let mobile = "";
let SID = "";
let currentIndex = 0;
let answers = {};    // index -> option value
let marked = {};     // index -> true/false
let visited = {};    // index -> true/false
let reviewMode = false;
let startTime = null;
let endTime = null;
let totalTimeSec = QUESTIONS.length * 60;
let timerInterval = null;

/* ========================= DOM NODES ======================== */
const loginModal = document.getElementById("loginModal");
const loginBtn = document.getElementById("loginBtn");
const resumeBtn = document.getElementById("resumeBtn");
const mobileInput = document.getElementById("mobileInput");
const loginError = document.getElementById("loginError");
const userMobileDisplay = document.getElementById("userMobileDisplay");

const mainApp = document.getElementById("mainApp");
const sectionsRow = document.getElementById("sectionsRow");
const qText = document.getElementById("qText");
const optionsBox = document.getElementById("optionsBox");
const qIndexText = document.getElementById("qIndexText");
const qSectionText = document.getElementById("qSectionText");
const markedStatus = document.getElementById("markedStatus");
const savedStatus = document.getElementById("savedStatus");
const timerDisplay = document.getElementById("timerDisplay");
const prevBtn = document.getElementById("prevBtn");
const nextBtn = document.getElementById("nextBtn");
const saveBtn = document.getElementById("saveBtn");
const markBtn = document.getElementById("markBtn");
const submitBtn = document.getElementById("submitBtn");
const paletteGrid = document.getElementById("paletteGrid");
const mobilePaletteGrid = document.getElementById("mobilePaletteGrid");
const paletteToggle = document.getElementById("paletteToggle");
const togglePaletteTop = document.getElementById("togglePaletteTop");
const mobilePalette = document.getElementById("mobilePalette");
const mobileClosePal = document.getElementById("mobileClosePal");
const overlay = document.getElementById("overlay");
const fullscreenBtn = document.getElementById("fullscreenBtn");
const showSummaryBtn = document.getElementById("showSummaryBtn");
const timePerTestText = document.getElementById("timePerTestText");

const summaryPage = document.getElementById("summaryPage");
const sum_total = document.getElementById("sum_total");
const sum_attempted = document.getElementById("sum_attempted");
const sum_notattempted = document.getElementById("sum_notattempted");
const sum_marked = document.getElementById("sum_marked");
const sum_attempted_marked = document.getElementById("sum_attempted_marked");
const sum_time = document.getElementById("sum_time");
const sum_score = document.getElementById("sum_score");
const returnTestBtn = document.getElementById("returnTestBtn");
const confirmSubmitBtn = document.getElementById("confirmSubmitBtn");
const finalPage = document.getElementById("finalPage");

/* ========================= TIMER ============================ */
function startTimer(){
  startTime = startTime || Date.now();
  const stored = localStorage.getItem(SID + ":timeLeft");
  let timeLeft = stored ? parseInt(stored,10) : totalTimeSec;
  timePerTestText.innerText = `${Math.floor(totalTimeSec/60)} min (${QUESTIONS.length} Qs)`;

  if(timerInterval) clearInterval(timerInterval);
  timerInterval = setInterval(()=>{
    const mm = Math.floor(timeLeft/60);
    const ss = timeLeft % 60;
    timerDisplay.innerText = `${String(mm).padStart(2,'0')}:${String(ss).padStart(2,'0')}`;
    localStorage.setItem(SID + ":timeLeft", timeLeft);
    if(timeLeft <= 0){
      clearInterval(timerInterval);
      alert("Time is up. Test will be submitted automatically.");
      openSummary(); // open summary automatically
    }
    timeLeft--;
  },1000);
}

/* ========================= SAVE / RESUME ======================= */
function makeSID(mobile){ return `SSC_EXAM_${mobile}_v1`; }
function saveState(){
  const data = { answers, marked, visited, currentIndex, reviewMode, startTime };
  localStorage.setItem(SID, JSON.stringify(data));
  localStorage.setItem(SID + ":timeLeft", localStorage.getItem(SID + ":timeLeft") || totalTimeSec);
  savedStatus.innerText = "Yes";
}
function loadState(){
  const raw = localStorage.getItem(SID);
  if(!raw) return false;
  try{
    const data = JSON.parse(raw);
    answers = data.answers || {};
    marked = data.marked || {};
    visited = data.visited || {};
    currentIndex = data.currentIndex || 0;
    reviewMode = data.reviewMode || false;
    startTime = data.startTime || Date.now();
    return true;
  }catch(e){ return false; }
}
function clearState(){ localStorage.removeItem(SID); localStorage.removeItem(SID + ":timeLeft"); }

/* ========================= UI RENDER ========================== */
function buildSections(){
  const secs = Array.from(new Set(QUESTIONS.map(q=>q.section)));
  sectionsRow.innerHTML = "";
  secs.forEach((s, idx) => {
    const el = document.createElement("div");
    el.className = "sectionBtn";
    el.innerText = s;
    el.onclick = () => {
      const first = QUESTIONS.findIndex(q => q.section === s);
      if(first >= 0){ currentIndex = first; renderQuestion(); saveState(); }
      document.querySelectorAll(".sectionBtn").forEach(x=>x.classList.remove("active"));
      el.classList.add("active");
    };
    if(idx === 0) el.classList.add("active");
    sectionsRow.appendChild(el);
  });
}

function renderQuestion(){
  const qObj = QUESTIONS[currentIndex];
  qIndexText.innerText = `Q ${currentIndex+1}`;
  qSectionText.innerText = qObj.section;
  qText.innerHTML = qObj.q;
  MathJax.typesetPromise().catch(()=>{});

  optionsBox.innerHTML = "";
  qObj.opts.forEach((opt, i) => {
    const d = document.createElement("div");
    d.className = "opt";
    d.innerText = opt;
    if(reviewMode){
      if(opt === qObj.key) d.classList.add("correct");
      if(answers[currentIndex] && answers[currentIndex] === opt && opt !== qObj.key) d.classList.add("wrong-selected");
      d.style.cursor = "default";
    } else {
      if(answers[currentIndex] === opt) d.classList.add("selected");
      d.onclick = () => {
        // Save but DO NOT auto-next
        answers[currentIndex] = opt;
        visited[currentIndex] = true;
        renderQuestion(); updatePalette(); saveState();
      };
    }
    optionsBox.appendChild(d);
  });

  markedStatus.innerText = marked[currentIndex] ? "Yes" : "No";
  savedStatus.innerText = localStorage.getItem(SID) ? "Yes" : "No";

  // Highlight active section button
  document.querySelectorAll(".sectionBtn").forEach(el=>{
    if(el.innerText === qObj.section) el.classList.add("active"); else el.classList.remove("active");
  });

  updatePalette();

  // Review mode: disable save/mark/submit but allow prev/next
  if(reviewMode){
    reviewBanner.style.display = "flex";
    saveBtn.disabled = true; saveBtn.style.opacity = 0.5;
    markBtn.disabled = true; markBtn.style.opacity = 0.5;
    submitBtn.disabled = true; submitBtn.style.opacity = 0.5;
    prevBtn.disabled = false; prevBtn.style.opacity = 1;
    nextBtn.disabled = false; nextBtn.style.opacity = 1;
  } else {
    reviewBanner.style.display = "none";
    saveBtn.disabled = false; saveBtn.style.opacity = 1;
    markBtn.disabled = false; markBtn.style.opacity = 1;
    submitBtn.disabled = false; submitBtn.style.opacity = 1;
    prevBtn.disabled = false; prevBtn.style.opacity = 1;
    nextBtn.disabled = false; nextBtn.style.opacity = 1;
  }
}

function updatePalette(){
  const pg = document.getElementById("paletteGrid");
  pg.innerHTML = "";
  const mobilePg = document.getElementById("mobilePaletteGrid");
  mobilePg.innerHTML = "";
  QUESTIONS.forEach((q, idx) => {
    const btn = document.createElement("div");
    btn.className = "pBtn " + (visited[idx] ? "visited" : "notVisited");
    if(marked[idx]) btn.className = "pBtn marked";
    if(idx === currentIndex) btn.classList.add("current");
    btn.innerText = idx+1;
    btn.onclick = () => {
      if(reviewMode) return; // disable palette navigation during review
      currentIndex = idx; renderQuestion(); saveState(); if(isMobile()) toggleMobilePal(false);
    };
    pg.appendChild(btn);
    const mb = btn.cloneNode(true);
    mb.onclick = btn.onclick;
    mobilePg.appendChild(mb);
  });
}

/* ========================= NAVIGATION ========================== */
const prev = document.getElementById("prevBtn");
const next = document.getElementById("nextBtn");
prev.onclick = () => { if(currentIndex > 0){ currentIndex--; renderQuestion(); saveState(); } };
next.onclick = () => { if(currentIndex < QUESTIONS.length-1){ currentIndex++; renderQuestion(); saveState(); } else { openSummary(); } };
saveBtn.onclick = () => { saveState(); alert("Saved locally"); };
markBtn.onclick = () => { if(reviewMode) return; marked[currentIndex] = !marked[currentIndex]; renderQuestion(); saveState(); };

/* ========================= PALETTE / MOBILE ======================= */
function isMobile(){ return window.innerWidth <= 950; }
let mobilePalOpen = false;
paletteToggle && (paletteToggle.onclick = () => { if(isMobile()) toggleMobilePal(true); else { document.querySelector('.palette').scrollIntoView({behavior:'smooth'}); } });
togglePaletteTop.onclick = () => { if(isMobile()) toggleMobilePal(true); else window.scrollTo({top:0, behavior:'smooth'}); };
mobileClosePal.onclick = () => toggleMobilePal(false);
function toggleMobilePal(open){
  mobilePalOpen = (open === undefined) ? !mobilePalOpen : open;
  if(mobilePalOpen){ mobilePalette.classList.add('open'); overlay.classList.add('show'); }
  else { mobilePalette.classList.remove('open'); overlay.classList.remove('show'); }
}
overlay.onclick = () => toggleMobilePal(false);

/* ========================= FULLSCREEN =========================== */
fullscreenBtn.onclick = () => {
  if (!document.fullscreenElement) { document.documentElement.requestFullscreen().catch(()=>{}); fullscreenBtn.innerText = "Exit Fullscreen"; }
  else { document.exitFullscreen().catch(()=>{}); fullscreenBtn.innerText = "Fullscreen"; }
};

/* ========================= SUMMARY PAGE ========================== */
function openSummary(){
  // compute stats
  const total = QUESTIONS.length;
  const attempted = Object.keys(answers).length;
  const notAttempted = total - attempted;
  const markedCount = Object.keys(marked).filter(k=>marked[k]).length;
  const attemptedMarked = Object.keys(answers).filter(k=>marked[k]).length;
  endTime = Date.now();
  const timeTakenSec = Math.max(0, Math.floor((endTime - (startTime || Date.now()))/1000));
  const mm = Math.floor(timeTakenSec/60), ss = timeTakenSec%60;
  const timeStr = `${mm}m ${ss}s`;

  // score calculation (1 mark for correct, 0 for wrong - adjust if needed)
  let score = 0;
  QUESTIONS.forEach((q, idx) => {
    if(answers[idx] && answers[idx] === q.key) score++;
  });

  // populate summary
  sum_total.innerText = total;
  sum_attempted.innerText = attempted;
  sum_notattempted.innerText = notAttempted;
  sum_marked.innerText = markedCount;
  sum_attempted_marked.innerText = attemptedMarked;
  sum_time.innerText = timeStr;
  sum_score.innerText = score + " / " + total;

  // show summary UI
  document.getElementById("mainApp").style.display = "none";
  summaryPage.style.display = "block";
}

/* Return to test from summary */
returnTestBtn.onclick = () => {
  summaryPage.style.display = "none";
  document.getElementById("mainApp").style.display = "grid";
};

/* Confirm submit from summary -> send to Google Form and enter review mode */
confirmSubmitBtn.onclick = () => {
  // prepare payload
  const payload = { mobile, answers, marked, visited, submittedAt: new Date().toISOString(), timeTakenMs: endTime - (startTime||Date.now()) };

  // send to Google Form (fire-and-forget)
  try{
    const FD = new FormData();
    FD.append(ENTRY_MOBILE, mobile);
    FD.append(ENTRY_ANSWERS, JSON.stringify(payload));
    fetch(GOOGLE_FORM_ACTION, { method:'POST', body:FD, mode:'no-cors' });
  }catch(e){ console.warn("Form submit failed", e); }

  // set review mode and save
  reviewMode = true;
  saveState();

  // show main app and render review
  summaryPage.style.display = "none";
  document.getElementById("mainApp").style.display = "grid";
  renderQuestion();

  // disable palette clicks in review (visual only)
  updatePalette();

  alert("Confirmed. Responses sent and entering Review Mode.");
  window.scrollTo({ top: 0, behavior: 'smooth' });
};

/* ========================= SUBMIT BUTTON (from main UI) ========= */
submitBtn.onclick = () => {
  // open summary instead of direct submit
  endTime = Date.now();
  openSummary();
};

/* ========================= LOGIN FLOW ============================ */
loginBtn.onclick = () => {
  const val = mobileInput.value.trim();
  if(!/^[6-9]\d{9}$/.test(val)){ loginError.innerText = "Enter a valid 10 digit mobile number"; return; }
  if(!VALID_MOBILE_NUMBERS.includes(val)){ loginError.innerText = "Mobile number not allowed (demo)"; return; }
  mobile = val; SID = makeSID(mobile);
  userMobileDisplay.innerText = mobile;
  loginModal.style.display = "none";
  document.getElementById("mainApp").style.display = "grid";

  const resumed = loadState();
  if(resumed){
    if(reviewMode){
      buildSections(); renderQuestion(); updatePalette(); reviewBanner.style.display = "flex"; startTimer();
    } else {
      if(!confirm("Resume previous saved test? Press OK to resume or Cancel to start fresh.")){
        clearState(); answers = {}; marked = {}; visited = {}; currentIndex = 0; reviewMode = false;
      }
      buildSections(); renderQuestion(); updatePalette(); startTimer(); saveState();
    }
  } else {
    buildSections(); renderQuestion(); updatePalette(); startTimer(); saveState();
  }
};

resumeBtn.onclick = () => {
  const val = mobileInput.value.trim();
  if(!/^[6-9]\d{9}$/.test(val)){ loginError.innerText = "Enter valid mobile number"; return; }
  if(!VALID_MOBILE_NUMBERS.includes(val)){ loginError.innerText = "Mobile number not allowed (demo)"; return; }
  mobile = val; SID = makeSID(mobile);
  userMobileDisplay.innerText = mobile;
  const got = loadState();
  if(!got){ loginError.innerText = "No saved test found for this mobile."; return; }
  loginModal.style.display = "none";
  document.getElementById("mainApp").style.display = "grid";
  buildSections(); renderQuestion(); updatePalette(); startTimer();
};

/* ========================= AUTO SAVE & UNLOAD ===================== */
window.addEventListener("beforeunload", function(e){
  if(localStorage.getItem(SID) && !reviewMode){
    e.preventDefault(); e.returnValue = '';
  }
});
window.addEventListener("unload", () => { saveState(); });
document.addEventListener("visibilitychange", () => { if(document.visibilityState === 'hidden') saveState(); });

/* ========================= INIT ================================== */
(function init(){
  // nothing until login; load minimal UI
  document.getElementById("mainApp").style.display = "none";
  // Prebuild palette placeholders
  const palette = document.getElementById("palette");
  palette.innerHTML = `<div style="padding:12px;">Loading...</div>`;
  // Build palette grid empty container
  const pg = document.createElement("div"); pg.id="paletteGrid"; pg.className="qgrid";
  palette.innerHTML = "";
  palette.appendChild(pg);
  buildSections();
  renderQuestion();
  updatePalette();
})();

/* ========================= UTIL ================================== */
function makeSID(mobile){ return `SSC_EXAM_${mobile}_v1`; }
function isMobile(){ return window.innerWidth <= 950; }

function toggleMobilePal(open){
  mobilePalOpen = (open === undefined) ? !mobilePalOpen : open;
  if(mobilePalOpen){ mobilePalette.classList.add('open'); overlay.classList.add('show'); }
  else { mobilePalette.classList.remove('open'); overlay.classList.remove('show'); }
}

/* disable devtools & selection best-effort */
(function disableShortcuts(){
  document.addEventListener('contextmenu', e => e.preventDefault());
  document.addEventListener('keydown', (e) => {
    if(e.key === "F12" || (e.ctrlKey && e.key==="u") || (e.ctrlKey && e.key==="s")) { e.preventDefault(); return false; }
    if(e.ctrlKey && (e.key === 'c' || e.key === 'v' || e.key === 'x' || e.key === 'a')) { e.preventDefault(); return false; }
    if(e.ctrlKey && e.shiftKey && (e.key === 'I' || e.key === 'J')) { e.preventDefault(); return false; }
  });
  document.addEventListener('selectstart', e => e.preventDefault());
})();
</script>

</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1, user-scalable=no">
<title>Single-Sheet Quiz (with Timer & Mobile Verify)</title>

<!-- Optional: MathJax if you use formulas -->
<script>
window.MathJax = {
  tex: { inlineMath: [['$', '$'], ['\\(', '\\)']], displayMath: [['$$','$$'], ['\\[','\\]']] },
  options: { renderActions: { addMenu: [] } },
  startup: { typeset: false }
};
</script>
<script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js" async></script>

<style>
  :root{--primary:#1E90FF;--accent:#1b4332;}
  body{font-family:Arial, sans-serif;margin:0;background:#f5f7fa;color:#111}
  .wrap{max-width:920px;margin:18px auto;padding:18px}
  h1{color:var(--primary);text-align:center;margin:6px 0 18px}
  .card{background:#fff;padding:14px;border-radius:10px;box-shadow:0 6px 18px rgba(10,10,10,0.05);margin-bottom:14px}
  input[type="text"],select{width:100%;padding:10px;border-radius:8px;border:1px solid #d0d7de;font-size:15px;box-sizing:border-box}
  button{background:var(--primary);color:#fff;border:none;padding:10px 14px;border-radius:8px;font-size:15px;cursor:pointer}
  .topbar{display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap}
  .question-nav{display:flex;gap:6px;overflow:auto;padding:8px 0,color:black}
  .question-nav button{width:36px;height:36px;border-radius:50%;border:1px solid #ddd;background:#fff}
  .question-nav button.answered{background:var(--accent);color:#fff;border-color:var(--accent)}
  .question-nav button.active{border:2px solid #333}
  .options label{display:block;border:1px solid #ddd;border-radius:8px;padding:10px;margin:8px 0;cursor:pointer}
  .options label.correct{background:#e8fce8;border-color:green}
  .options label.wrong{background:#ffe8e8;border-color:red}
  .footer-fixed{position:fixed;left:0;right:0;bottom:8px;display:flex;justify-content:center;gap:8px;padding:0 12px;pointer-events:none}
  .footer-fixed .btn{pointer-events:auto;max-width:920px;width:100%;display:flex;gap:8px}
  .footer-fixed button{flex:1}
  #timer{font-weight:700;color:#c0392b}
  #result-section{display:none;margin-top:10px}
  .hidden{display:none}
  @media (max-width:640px){ .topbar{flex-direction:column;align-items:stretch} }
</style>
</head>
<body>
<div class="wrap">

  <h1>Quiz</h1>

  <!-- MOBILE VERIFICATION -->
  <div id="mobile-card" class="card">
    <h3>Enter registered mobile number</h3>
    <input id="mobileInput" type="text" placeholder="Mobile number (e.g. 6301186741)" />
    <div style="margin-top:10px;text-align:center">
      <button onclick="verifyMobile()">Verify & Continue</button>
    </div>
    <p style="color:#666;font-size:13px;margin-top:8px">Note: Edit <code>allowedMobiles</code> in the script to configure which numbers are allowed.</p>
  </div>

  <!-- QUIZ AREA -->
  <div id="quiz-area" class="card hidden">
    <div class="topbar" style="margin-bottom:10px;">
      <div style="display:flex;align-items:center;gap:10px;">
        <div>
          <label><strong>Quiz (Sheet):</strong></label>
          <div id="quizNameDisplay" style="padding:8px 10px;background:#fafafa;border-radius:8px;border:1px solid #eee"></div>
        </div>
      </div>

      <div style="text-align:right;">
        <div id="stats" style="font-size:14px;margin-bottom:6px;">
          <span id="answered">Answered: 0</span> &nbsp;|&nbsp;
          <span id="not-answered">Not answered: 0</span>
        </div>
        <div>Timer: <span id="timer">00:00</span></div>
      </div>
    </div>

    <div id="question-nav" class="question-nav"></div>

    <div id="question-container"></div>

    <div id="result-section" class="card"></div>
  </div>

</div>

<!-- Footer fixed navigation -->
<div class="footer-fixed">
  <div class="btn" style="max-width:920px;margin:0 auto">
    <button onclick="prevQuestion()">Previous</button>
    <button id="submitBtn" onclick="submitQuiz()">Submit</button>
    <button onclick="nextQuestion()">Next</button>
  </div>
</div>

<script>
/* ================== CONFIG â€” EDIT THESE ================== */

/* -> Put your sheet id and sheet name here <- */
const SHEET_ID = "1qRFUQ_S_7pK_mb-cZb30CwcN6Gkb91A25Eq2JMefZNo";   // e.g. "1qRFUQ_S_7pK_..."
const SHEET_NAME = "QuadraticEquations";             // e.g. "Maths" (sheet/tab name)

/* Timer: seconds per question */
const SECONDS_PER_QUESTION = 60; // change to desired seconds per question

/* Allowed / registered mobile numbers (edit for your users) */
const allowedMobiles = ["6301186741","9876543210"]; // add numbers as needed

/* Google Form (re-using your previous IDs) */
const FORM_URL = "https://docs.google.com/forms/d/e/1FAIpQLSfVoWZdJJTPQhxRCzPhD7UkbMYt13d1pzeWkm7a8Tvbil1P5A/formResponse";
const ENTRY_MOBILE  = "entry.1096987326";
const ENTRY_QUIZ    = "entry.1993342463";
const ENTRY_SCORE   = "entry.1053562570";
const ENTRY_CORRECT = "entry.1154826868";
const ENTRY_WRONG   = "entry.1442969806";
const ENTRY_SKIP    = "entry.770173959";

/* ======================================================== */

/* Derived sheet JSON URL (Google visualization API) */
const SHEET_JSON_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(SHEET_NAME)}`;

/* State */
let allQuestions = [];
let answers = [];       // stores chosen option index or null
let current = 0;
let submitted = false;
let userMobile = "";
let timerTotal = 0;
let timerInterval = null;

/* ----------------- LOAD SHEET ----------------- */
async function loadQuestionsFromSheet(){
  try {
    const res = await fetch(SHEET_JSON_URL);
    let text = await res.text();
    // extract JSON payload
    text = text.substring(text.indexOf("{"), text.lastIndexOf("}") + 1);
    const data = JSON.parse(text);

    // Expected columns per row in this order:
    // [0] Question, [1] Option1, [2] Option2, [3] Option3, [4] Option4, [5] answerIndex (0-based)
    allQuestions = (data.table.rows || []).map(r => ({
      q: r.c[0] ? r.c[0].v : "",
      opts: [
        r.c[1] ? r.c[1].v : "",
        r.c[2] ? r.c[2].v : "",
        r.c[3] ? r.c[3].v : "",
        r.c[4] ? r.c[4].v : ""
      ],
      answerId: (r.c[5] && r.c[5].v !== null && r.c[5].v !== undefined) ? Number(r.c[5].v) : null
    }));

    if(allQuestions.length === 0){
      alert("No questions found in the specified sheet. Check SHEET_NAME and sheet data.");
      return;
    }

    // initialize
    answers = Array(allQuestions.length).fill(null);
    current = 0;
    submitted = false;

    // set timer
    timerTotal = allQuestions.length * SECONDS_PER_QUESTION;
    updateTimerDisplay();

    // show quiz name and area
    document.getElementById("quizNameDisplay").textContent = SHEET_NAME;
    document.getElementById("mobile-card").classList.add('hidden');
    document.getElementById("quiz-area").classList.remove('hidden');

    renderNav();
    renderQuestion();

    // start timer
    startTimer();

  } catch (err) {
    console.error("Error loading sheet:", err);
    alert("Failed to load sheet. Ensure SHEET_ID and SHEET_NAME are correct and sheet is shared (Anyone with link can view).");
  }
}

/* ----------------- MOBILE VERIFICATION ----------------- */
function verifyMobile(){
  const m = document.getElementById("mobileInput").value.trim();
  if(!m){ alert("Please enter mobile number"); return; }
  if(!allowedMobiles.includes(m)){
    alert("Mobile number not registered. Contact admin.");
    return;
  }
  userMobile = m;
  // load sheet after verification
  loadQuestionsFromSheet();
}

/* ----------------- RENDER NAV ----------------- */
function renderNav(){
  const nav = document.getElementById("question-nav");
  nav.innerHTML = "";
  allQuestions.forEach((q, i) => {
    const btn = document.createElement("button");
    btn.textContent = i+1;
    btn.className = "";
    if(i === current) btn.classList.add("active");
    if(answers[i] !== null) btn.classList.add("answered");
    btn.onclick = ()=> { current = i; renderQuestion(); };
    nav.appendChild(btn);
  });
  updateStats();
}

/* ----------------- RENDER QUESTION ----------------- */
function renderQuestion(){
  const container = document.getElementById("question-container");
  const qObj = allQuestions[current];
  let html = `<h3>Question ${current+1} of ${allQuestions.length}</h3>`;
  html += `<p style="font-size:16px;margin:6px 0 12px;">${escapeHtml(qObj.q)}</p>`;
  html += `<div class="options">`;
  qObj.opts.forEach((opt, idx) => {
    let cls = "";
    if(submitted){
      if(qObj.answerId === idx) cls = "correct";
      else if(answers[current] === idx && qObj.answerId !== idx) cls = "wrong";
    }
    const checked = (answers[current] === idx) ? "checked" : "";
    const disabled = submitted ? "disabled" : "";
    html += `<label class="${cls}">
               <input type="radio" name="opt" value="${idx}" ${checked} ${disabled} onchange="selectOpt(${idx})" />
               ${escapeHtml(opt)}
             </label>`;
  });
  html += `</div>`;
  container.innerHTML = html;

  // MathJax typeset if present
  if(window.MathJax && MathJax.typesetPromise) MathJax.typesetPromise([container]);

  renderNav();
}

/* ----------------- SELECT OPTION ----------------- */
function selectOpt(i){
  if(submitted) return;
  answers[current] = i;
  renderNav();
}

/* ----------------- NAVIGATION ----------------- */
function nextQuestion(){ if(current < allQuestions.length -1){ current++; renderQuestion(); } }
function prevQuestion(){ if(current > 0){ current--; renderQuestion(); } }

/* ----------------- STATS ----------------- */
function updateStats(){
  const answeredCount = answers.filter(a => a !== null).length;
  document.getElementById("answered").textContent = "Answered: " + answeredCount;
  document.getElementById("not-answered").textContent = "Not answered: " + (allQuestions.length - answeredCount);
}

/* ----------------- TIMER ----------------- */
function startTimer(){
  if(timerInterval) clearInterval(timerInterval);
  timerInterval = setInterval(() => {
    timerTotal--;
    updateTimerDisplay();
    if(timerTotal <= 0){
      clearInterval(timerInterval);
      timerInterval = null;
      // auto submit when time ends
      submitQuiz();
    }
  }, 1000);
}

function updateTimerDisplay(){
  const m = Math.floor(timerTotal / 60);
  let s = timerTotal % 60;
  s = s < 10 ? "0"+s : s;
  document.getElementById("timer").textContent = `${m}:${s}`;
}

/* ----------------- SUBMIT QUIZ ----------------- */
function submitQuiz(){
  if(submitted) return;
  submitted = true;
  if(timerInterval){ clearInterval(timerInterval); timerInterval = null; }

  // compute results
  let correct = 0, wrong = 0;
  for(let i=0;i<allQuestions.length;i++){
    const q = allQuestions[i];
    if(answers[i] === null) continue;
    if(q.answerId !== null && answers[i] === q.answerId) correct++;
    else wrong++;
  }
  const skipped = allQuestions.length - (correct + wrong);
  const score = Math.round((correct / allQuestions.length) * 100);

  // render current question to show correct/wrong highlights
  renderQuestion();

  // show result panel
  const rs = document.getElementById("result-section");
  rs.style.display = "block";
  rs.innerHTML = `
    <h3>Quiz Submitted</h3>
    <p><b>Mobile:</b> ${escapeHtml(userMobile)}</p>
    <p><b>Quiz (sheet):</b> ${escapeHtml(SHEET_NAME)}</p>
    <p><b>Total Questions:</b> ${allQuestions.length}</p>
    <p><b>Correct:</b> ${correct}</p>
    <p><b>Wrong:</b> ${wrong}</p>
    <p><b>Skipped:</b> ${skipped}</p>
    <p><b>Score:</b> ${score}%</p>
  `;

  // disable all radios
  document.querySelectorAll('input[type="radio"]').forEach(r => r.disabled = true);

  // send to Google Form (fire-and-forget)
  sendResultsToForm(userMobile, SHEET_NAME, score, correct, wrong, skipped);
}

/* ----------------- SEND RESULTS TO GOOGLE FORM ----------------- */
function sendResultsToForm(mobile, quizName, score, correct, wrong, skipped){
  try {
    const fd = new FormData();
    fd.append(ENTRY_MOBILE, mobile);
    fd.append(ENTRY_QUIZ, quizName);
    fd.append(ENTRY_SCORE, String(score));
    fd.append(ENTRY_CORRECT, String(correct));
    fd.append(ENTRY_WRONG, String(wrong));
    fd.append(ENTRY_SKIP, String(skipped));

    fetch(FORM_URL, { method:'POST', body: fd, mode: 'no-cors' }).catch(e => {
      console.warn("Form submit warning (expected in no-cors):", e);
    });
  } catch (e){
    console.error("Error sending results:", e);
  }
}

/* ----------------- UTIL ----------------- */
function escapeHtml(str){
  if(str === null || str === undefined) return "";
  return String(str).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;");
}

/* ----------------- STARTUP ----------------- */
/* Nothing runs until mobile is verified. User inputs mobile and we call loadQuestionsFromSheet() */
</script>
</body>
</html>
